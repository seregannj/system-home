#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266HTTPClient.h>

// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
const char* WIFI_SSID = "–í–ê–®_WIFI_SSID";
const char* WIFI_PASS = "–í–ê–®_WIFI_PASSWORD";

const char* SERVER_IP = "192.168.1.100";  // IP –≤–∞—à–µ–≥–æ –ü–ö —Å —Å–µ—Ä–≤–µ—Ä–æ–º
const int SERVER_PORT = 5000;

const char* DEVICE_ID = "smart_lamp_001";
const char* DEVICE_NAME = "–£–º–Ω–∞—è –ª–∞–º–ø–∞";
const char* DEVICE_TYPE = "light";

const int LAMP_PIN = D1;  // GPIO5 (D1) –¥–ª—è —Ä–µ–ª–µ/–ª–∞–º–ø—ã
// ===============================

WiFiClient client;
HTTPClient http;
bool lampState = false;
unsigned long lastCheck = 0;
const unsigned long CHECK_INTERVAL = 1000;  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n===== SMART LAMP ESP8266 =====");
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–∞ –ª–∞–º–ø—ã
  pinMode(LAMP_PIN, OUTPUT);
  digitalWrite(LAMP_PIN, LOW);  // –í—ã–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  
  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi
  connectToWiFi();
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  registerDevice();
  
  Serial.println("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ");
  Serial.println("============================\n");
}

void loop() {
  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å WiFi
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("–ü–æ—Ç–µ—Ä—è–Ω–æ WiFi —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");
    connectToWiFi();
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
  if (millis() - lastCheck > CHECK_INTERVAL) {
    checkForCommands();
    lastCheck = millis();
  }
  
  delay(10);
}

void connectToWiFi() {
  Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi: ");
  Serial.println(WIFI_SSID);
  
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi –ø–æ–¥–∫–ª—é—á–µ–Ω!");
    Serial.print("IP –∞–¥—Ä–µ—Å: ");
    Serial.println(WiFi.localIP());
    Serial.print("MAC –∞–¥—Ä–µ—Å: ");
    Serial.println(WiFi.macAddress());
  } else {
    Serial.println("\n–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WiFi!");
  }
}

void registerDevice() {
  Serial.println("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...");
  
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/register";
  
  http.begin(client, serverURL);
  http.addHeader("Content-Type", "application/json");
  
  // JSON –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  String jsonData = "{";
  jsonData += "\"id\":\"" + String(DEVICE_ID) + "\",";
  jsonData += "\"name\":\"" + String(DEVICE_NAME) + "\",";
  jsonData += "\"type\":\"" + String(DEVICE_TYPE) + "\",";
  jsonData += "\"icon\":\"üí°\",";
  jsonData += "\"description\":\"–£–º–Ω–∞—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–Ω–∞—è –ª–∞–º–ø–∞\",";
  jsonData += "\"commands\":[\"on\",\"off\",\"toggle\"]";
  jsonData += "}";
  
  int httpCode = http.POST(jsonData);
  
  if (httpCode > 0) {
    Serial.print("–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ");
    Serial.println(httpCode);
    
    if (httpCode == HTTP_CODE_OK) {
      String response = http.getString();
      Serial.println("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
      Serial.println("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + response);
      
      // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      sendStatus("off");
    }
  } else {
    Serial.print("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ");
    Serial.println(http.errorToString(httpCode).c_str());
  }
  
  http.end();
}

void checkForCommands() {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/command/" + String(DEVICE_ID) + "/check";
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    String command = http.getString();
    command.trim();
    
    if (command.length() > 0) {
      Serial.print("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: ");
      Serial.println(command);
      
      processCommand(command);
    }
  } else if (httpCode < 0) {
    // –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    Serial.print("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–∞–Ω–¥: ");
    Serial.println(http.errorToString(httpCode).c_str());
  }
  
  http.end();
}

void processCommand(String command) {
  if (command == "on") {
    turnOn();
  } else if (command == "off") {
    turnOff();
  } else if (command == "toggle") {
    toggle();
  }
}

void turnOn() {
  digitalWrite(LAMP_PIN, HIGH);
  lampState = true;
  Serial.println("–õ–∞–º–ø–∞: –í–ö–õ–Æ–ß–ï–ù–û");
  sendStatus("on");
  
  // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–∞ ESP
  for (int i = 0; i < 3; i++) {
    digitalWrite(LED_BUILTIN, LOW);
    delay(100);
    digitalWrite(LED_BUILTIN, HIGH);
    delay(100);
  }
}

void turnOff() {
  digitalWrite(LAMP_PIN, LOW);
  lampState = false;
  Serial.println("–õ–∞–º–ø–∞: –í–´–ö–õ–Æ–ß–ï–ù–û");
  sendStatus("off");
  
  // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–∞ ESP
  digitalWrite(LED_BUILTIN, HIGH);
  delay(300);
  digitalWrite(LED_BUILTIN, LOW);
  delay(300);
  digitalWrite(LED_BUILTIN, HIGH);
}

void toggle() {
  lampState = !lampState;
  digitalWrite(LAMP_PIN, lampState ? HIGH : LOW);
  Serial.println("–õ–∞–º–ø–∞: " + String(lampState ? "–í–ö–õ–Æ–ß–ï–ù–û" : "–í–´–ö–õ–Æ–ß–ï–ù–û"));
  sendStatus(lampState ? "on" : "off");
  
  // –ú–∏–≥–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º
  for (int i = 0; i < 5; i++) {
    digitalWrite(LED_BUILTIN, !digitalRead(LED_BUILTIN));
    delay(50);
  }
  digitalWrite(LED_BUILTIN, HIGH);
}

void sendStatus(String status) {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/update_status/" + String(DEVICE_ID) + "/" + status;
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    Serial.println("–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä: " + status);
  }
  
  http.end();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Serial
void handleSerialCommands() {
  if (Serial.available() > 0) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    
    if (cmd == "on") turnOn();
    else if (cmd == "off") turnOff();
    else if (cmd == "toggle") toggle();
    else if (cmd == "status") {
      Serial.print("–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ");
      Serial.println(lampState ? "–í–ö–õ" : "–í–´–ö–õ");
      Serial.print("WiFi —Å—Ç–∞—Ç—É—Å: ");
      Serial.println(WiFi.status() == WL_CONNECTED ? "–ü–æ–¥–∫–ª—é—á–µ–Ω" : "–û—Ç–∫–ª—é—á–µ–Ω");
      Serial.print("IP: ");
      Serial.println(WiFi.localIP());
    }
    else if (cmd == "help") {
      Serial.println("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:");
      Serial.println("  on     - –≤–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É");
      Serial.println("  off    - –≤—ã–∫–ª—é—á–∏—Ç—å –ª–∞–º–ø—É");
      Serial.println("  toggle - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å");
      Serial.println("  status - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
      Serial.println("  help   - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞");
    }
  }
}
