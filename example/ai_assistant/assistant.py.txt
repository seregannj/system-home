#!/usr/bin/env python3
"""
SystemHome Voice Assistant v2.0
–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ —Å OpenAI GPT –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–º–Ω—ã–º –¥–æ–º–æ–º
"""

import os
import json
import requests
import openai
import speech_recognition as sr
import pyttsx3
import threading
import queue
import time
import logging
from datetime import datetime
from typing import Dict, List, Optional
import re

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
class Config:
    # OpenAI
    OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "sk-–≤–∞—à-api-–∫–ª—é—á")  # –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞ platform.openai.com
    OPENAI_MODEL = "gpt-3.5-turbo"  # –∏–ª–∏ "gpt-4"
    
    # –°–µ—Ä–≤–µ—Ä —É–º–Ω–æ–≥–æ –¥–æ–º–∞
    SERVER_IP = "192.168.1.100"
    SERVER_PORT = 5000
    SERVER_URL = f"http://{SERVER_IP}:{SERVER_PORT}"
    
    # –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    DEVICE_ID = "ai_assistant_001"
    DEVICE_NAME = "–ò–ò –ü–æ–º–æ—â–Ω–∏–∫"
    
    # –ì–æ–ª–æ—Å
    LANGUAGE = "ru-RU"
    VOICE_RATE = 180
    VOICE_VOLUME = 0.9
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    WAKE_WORDS = ["–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç", "–ø–æ–º–æ—â–Ω–∏–∫", "—ç–π", "–æ–∫–µ–π –≥—É–≥–ª", "–∞–ª–∏—Å–∞", "—Å–∏—Ä–∏"]
# ==================================

class VoiceAssistant:
    def __init__(self):
        self.config = Config()
        self.devices = []  # –ö—ç—à —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        self.is_running = True
        self.is_listening = False
        
        # OpenAI –∫–ª–∏–µ–Ω—Ç
        openai.api_key = self.config.OPENAI_API_KEY
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        self.recognizer = sr.Recognizer()
        self.recognizer.energy_threshold = 300
        self.recognizer.dynamic_energy_threshold = True
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
        self.tts_engine = pyttsx3.init()
        self.tts_engine.setProperty('rate', self.config.VOICE_RATE)
        self.tts_engine.setProperty('volume', self.config.VOICE_VOLUME)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
        self._set_russian_voice()
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('assistant.log'),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger("VoiceAssistant")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        self.register_assistant()
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        self.load_devices()
        
        self.logger.info("–ò–ò –ü–æ–º–æ—â–Ω–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    def _set_russian_voice(self):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä—É—Å—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞"""
        voices = self.tts_engine.getProperty('voices')
        for voice in voices:
            if 'russian' in voice.name.lower() or 'ru' in voice.id.lower():
                self.tts_engine.setProperty('voice', voice.id)
                self.logger.info(f"–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≥–æ–ª–æ—Å: {voice.name}")
                return
    
    def register_assistant(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–º–æ—â–Ω–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–º–Ω–æ–≥–æ –¥–æ–º–∞"""
        try:
            config = {
                "id": self.config.DEVICE_ID,
                "name": self.config.DEVICE_NAME,
                "type": "assistant",
                "icon": "ü§ñ",
                "description": "–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ —Å –ò–ò OpenAI",
                "commands": ["listen", "speak", "control", "list_devices"],
                "status": "online"
            }
            
            response = requests.post(
                f"{self.config.SERVER_URL}/register",
                json=config,
                timeout=5
            )
            
            if response.status_code == 200:
                self.logger.info("–ü–æ–º–æ—â–Ω–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ")
                self.update_status("online")
            else:
                self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {response.status_code}")
                
        except Exception as e:
            self.logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è: {e}")
    
    def load_devices(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞"""
        try:
            response = requests.get(
                f"{self.config.SERVER_URL}/devices",
                timeout=5
            )
            
            if response.status_code == 200:
                self.devices = response.json()
                self.logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(self.devices)} —É—Å—Ç—Ä–æ–π—Å—Ç–≤")
            else:
                self.logger.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤")
                
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: {e}")
    
    def update_status(self, status: str):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–º–æ—â–Ω–∏–∫–∞"""
        try:
            requests.get(
                f"{self.config.SERVER_URL}/update_status/{self.config.DEVICE_ID}/{status}",
                timeout=3
            )
        except:
            pass
    
    def speak(self, text: str):
        """–û–∑–≤—É—á–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞"""
        if not text:
            return
        
        self.logger.info(f"–ì–æ–≤–æ—Ä—é: {text}")
        self.update_status("speaking")
        
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
            sentences = re.split(r'[.!?]+', text)
            for sentence in sentences:
                if sentence.strip():
                    self.tts_engine.say(sentence.strip())
            self.tts_engine.runAndWait()
            
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏: {e}")
            print(f"–ü–æ–º–æ—â–Ω–∏–∫: {text}")  # –§–æ–ª–±—ç–∫ –≤ –∫–æ–Ω—Å–æ–ª—å
        
        finally:
            time.sleep(0.5)
            self.update_status("online")
    
    def listen(self) -> Optional[str]:
        """–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã"""
        with sr.Microphone() as source:
            self.logger.info("–°–ª—É—à–∞—é...")
            self.is_listening = True
            
            try:
                # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –æ–∫—Ä—É–∂–∞—é—â–µ–≥–æ —à—É–º–∞
                self.recognizer.adjust_for_ambient_noise(source, duration=0.5)
                
                # –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
                audio = self.recognizer.listen(
                    source, 
                    timeout=5,
                    phrase_time_limit=10
                )
                
                # –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Google Speech Recognition
                text = self.recognizer.recognize_google(
                    audio, 
                    language=self.config.LANGUAGE
                )
                
                self.logger.info(f"–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: {text}")
                return text.lower()
                
            except sr.WaitTimeoutError:
                self.speak("–Ø –Ω–µ —É—Å–ª—ã—à–∞–ª–∞ –∫–æ–º–∞–Ω–¥—É")
            except sr.UnknownValueError:
                self.speak("–ù–µ –ø–æ–Ω—è–ª–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞")
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: {e}")
                self.speak("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏")
            
            finally:
                self.is_listening = False
            
            return None
    
    def listen_for_wake_word(self) -> bool:
        """–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞"""
        with sr.Microphone() as source:
            try:
                audio = self.recognizer.listen(
                    source, 
                    timeout=3,
                    phrase_time_limit=2
                )
                
                text = self.recognizer.recognize_google(
                    audio,
                    language=self.config.LANGUAGE
                ).lower()
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                for wake_word in self.config.WAKE_WORDS:
                    if wake_word in text:
                        return True
                        
            except (sr.WaitTimeoutError, sr.UnknownValueError):
                pass
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–∏ wake word: {e}")
            
            return False
    
    def process_with_openai(self, user_input: str) -> str:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ OpenAI GPT
        —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —É–º–Ω–æ–≥–æ –¥–æ–º–∞
        """
        try:
            # –°–æ–∑–¥–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —É–º–Ω–æ–≥–æ –¥–æ–º–∞
            system_prompt = """–¢—ã –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —É–º–Ω–æ–≥–æ –¥–æ–º–∞ SystemHome.
            
            –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ –∫–æ–º–∞–Ω–¥—ã:
            {devices_info}
            
            –ü—Ä–∞–≤–∏–ª–∞:
            1. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ
            2. –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ —Å–≤—è–∑–∞–Ω–∞ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ - –≤—ã–ø–æ–ª–Ω—è–π –µ—ë
            3. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å - –∑–∞–¥–∞–π –æ–¥–∏–Ω –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å
            4. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ - —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º —á–µ—Å—Ç–Ω–æ
            
            –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {current_time}"""
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            devices_info = []
            for device in self.devices:
                device_info = f"- {device['name']} (ID: {device['id']}, –¢–∏–ø: {device['type']})"
                if device.get('config', {}).get('commands'):
                    commands = ', '.join(device['config']['commands'])
                    device_info += f" [–ö–æ–º–∞–Ω–¥—ã: {commands}]"
                devices_info.append(device_info)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            full_prompt = system_prompt.format(
                devices_info='\n'.join(devices_info),
                current_time=datetime.now().strftime("%H:%M %d.%m.%Y")
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
            response = openai.ChatCompletion.create(
                model=self.config.OPENAI_MODEL,
                messages=[
                    {"role": "system", "content": full_prompt},
                    {"role": "user", "content": user_input}
                ],
                max_tokens=150,
                temperature=0.7,
                n=1
            )
            
            answer = response.choices[0].message.content.strip()
            self.logger.info(f"OpenAI –æ—Ç–≤–µ—Ç: {answer}")
            
            # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            self._extract_and_execute_commands(answer, user_input)
            
            return answer
            
        except openai.error.OpenAIError as e:
            self.logger.error(f"OpenAI –æ—à–∏–±–∫–∞: {e}")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ò–ò —Å–µ—Ä–≤–∏—Å–æ–º"
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã: {e}")
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã"
    
    def _extract_and_execute_commands(self, ai_response: str, user_input: str):
        """
        –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ò–ò
        """
        # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ –∏–∑ –æ—Ç–≤–µ—Ç–∞
        command_patterns = [
            r"(–≤–∫–ª—é—á–∏|–≤—ã–∫–ª—é—á–∏|–ø–µ—Ä–µ–∫–ª—é—á–∏|–∏–∑–º–µ–Ω–∏) (.+?) (–Ω–∞|–≤|–¥–æ)?\s*(\d+)?",
            r"(—É—Å—Ç–∞–Ω–æ–≤–∏|–ø–æ—Å—Ç–∞–≤—å) (.+?) (–Ω–∞|–≤)\s*(\d+)",
            r"(—Å–¥–µ–ª–∞–π|–∏–∑–º–µ–Ω–∏) (.+?) (—Ç–µ–ø–ª–µ–µ|—Ö–æ–ª–æ–¥–Ω–µ–µ|—è—Ä—á–µ|—Ç–µ–º–Ω–µ–µ)"
        ]
        
        # –°–ª–æ–≤–∞—Ä—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –∏—Ö ID
        device_map = {}
        for device in self.devices:
            device_map[device['name'].lower()] = device['id']
            # –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã
            if device['type'] == 'light':
                device_map['—Å–≤–µ—Ç'] = device['id']
                device_map['–ª–∞–º–ø—É'] = device['id']
                device_map['–ª–∞–º–ø—ã'] = device['id']
            elif device['type'] == 'socket':
                device_map['—Ä–æ–∑–µ—Ç–∫—É'] = device['id']
                device_map['—Ä–æ–∑–µ—Ç–∫–∏'] = device['id']
        
        # –ü–æ–∏—Å–∫ –∫–æ–º–∞–Ω–¥ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –≤–≤–æ–¥–µ (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
        for device_name, device_id in device_map.items():
            if device_name in user_input.lower():
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É
                if any(cmd in user_input.lower() for cmd in ['–≤–∫–ª—é—á–∏', '–≤–∫–ª—é—á–∏—Ç—å', '–≤–∫–ª—é—á–µ–Ω–æ']):
                    self.control_device(device_id, "on")
                elif any(cmd in user_input.lower() for cmd in ['–≤—ã–∫–ª—é—á–∏', '–≤—ã–∫–ª—é—á–∏—Ç—å', '–≤—ã–∫–ª—é—á–µ–Ω–æ']):
                    self.control_device(device_id, "off")
                elif '–ø–µ—Ä–µ–∫–ª—é—á–∏' in user_input.lower() or 'toggle' in user_input.lower():
                    self.control_device(device_id, "toggle")
                break
    
    def control_device(self, device_id: str, command: str):
        """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º"""
        try:
            response = requests.get(
                f"{self.config.SERVER_URL}/command/{device_id}/{command}",
                timeout=5
            )
            
            if response.status_code == 200:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                requests.get(
                    f"{self.config.SERVER_URL}/update_status/{device_id}/{command}",
                    timeout=3
                )
                self.logger.info(f"–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ {device_id} –ø–æ–ª—É—á–∏–ª–æ –∫–æ–º–∞–Ω–¥—É: {command}")
            else:
                self.logger.error(f"–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º {device_id}")
                
        except Exception as e:
            self.logger.error(f"–û—à–∏–±–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º {device_id}: {e}")
    
    def get_devices_info(self) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö"""
        if not self.devices:
            return "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
        
        online_devices = [d for d in self.devices if d.get('status') == 'online']
        offline_devices = [d for d in self.devices if d.get('status') == 'offline']
        
        info = f"–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: {len(self.devices)}. "
        info += f"–û–Ω–ª–∞–π–Ω: {len(online_devices)}, "
        info += f"–û—Ñ–ª–∞–π–Ω: {len(offline_devices)}."
        
        if online_devices:
            info += " –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: "
            info += ", ".join([d['name'] for d in online_devices])
        
        return info
    
    def handle_conversation(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∞–ª–æ–≥–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"""
        self.speak("–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–º–Ω–æ–≥–æ –¥–æ–º–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?")
        
        while self.is_running:
            try:
                # –ñ–¥–µ–º –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ
                if self.listen_for_wake_word():
                    self.speak("–î–∞, —Å–ª—É—à–∞—é –≤–∞—Å")
                    
                    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É
                    command = self.listen()
                    
                    if command:
                        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã
                        if any(word in command for word in [
                            '—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', '—á—Ç–æ –µ—Å—Ç—å', '—Å–ø–∏—Å–æ–∫', '–∫–∞–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞'
                        ]):
                            # –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                            devices_info = self.get_devices_info()
                            self.speak(devices_info)
                        
                        elif any(word in command for word in [
                            '–ø–æ–º–æ—â—å', '—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å', '–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏'
                        ]):
                            # –°–ø—Ä–∞–≤–∫–∞
                            help_text = """
                            –Ø —É–º–µ—é:
                            1. –£–ø—Ä–∞–≤–ª—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ —É–º–Ω–æ–≥–æ –¥–æ–º–∞ (–≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç, —Ä–æ–∑–µ—Ç–∫–∏)
                            2. –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                            3. –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–≥–æ–¥–µ, –≤—Ä–µ–º–µ–Ω–∏
                            4. –ü–æ–º–æ—á—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã
                            –ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å!
                            """
                            self.speak(help_text)
                        
                        elif any(word in command for word in [
                            '–≤—Ä–µ–º—è', '–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å', '–¥–∞—Ç–∞', '—Å–µ–≥–æ–¥–Ω—è'
                        ]):
                            # –í—Ä–µ–º—è –∏ –¥–∞—Ç–∞
                            now = datetime.now()
                            time_str = now.strftime("%H:%M")
                            date_str = now.strftime("%d %B %Y –≥–æ–¥–∞")
                            self.speak(f"–°–µ–π—á–∞—Å {time_str}. {date_str}")
                        
                        elif any(word in command for word in [
                            '–ø–æ–≥–æ–¥–∞', '—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞', '–Ω–∞ —É–ª–∏—Ü–µ'
                        ]):
                            # –ü–æ–≥–æ–¥–∞ (–∑–∞–≥–ª—É—à–∫–∞)
                            weather_text = self._get_weather()
                            self.speak(weather_text)
                        
                        else:
                            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ OpenAI
                            self.speak("–î—É–º–∞—é...")
                            response = self.process_with_openai(command)
                            self.speak(response)
                
                # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
                time.sleep(0.5)
                
            except KeyboardInterrupt:
                self.logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è")
                self.stop()
                break
            except Exception as e:
                self.logger.error(f"–û—à–∏–±–∫–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ: {e}")
                time.sleep(1)
    
    def _get_weather(self) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã (–∑–∞–≥–ª—É—à–∫–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)"""
        # –ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å OpenWeatherMap API
        weather_options = [
            "–°–µ–≥–æ–¥–Ω—è —Å–æ–ª–Ω–µ—á–Ω–æ, +22 –≥—Ä–∞–¥—É—Å–∞, –ª–µ–≥–∫–∏–π –≤–µ—Ç–µ—Ä–æ–∫",
            "–ü–∞—Å–º—É—Ä–Ω–æ, +18, –≤–æ–∑–º–æ–∂–µ–Ω –Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å",
            "–Ø—Å–Ω–∞—è –ø–æ–≥–æ–¥–∞, +25, –æ—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª–∫–∏",
            "–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ, +15 –≥—Ä–∞–¥—É—Å–æ–≤, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞–¥–µ—Ç—å –∫—É—Ä—Ç–∫—É"
        ]
        import random
        return random.choice(weather_options)
    
    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–º–æ—â–Ω–∏–∫–∞"""
        self.is_running = False
        self.update_status("offline")
        self.logger.info("–ü–æ–º–æ—â–Ω–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

# ========== –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–° –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø ==========

from flask import Flask, render_template, jsonify, request, Response
import threading

app = Flask(__name__)
assistant_instance = None

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
    return render_template('assistant_web.html')

@app.route('/api/status')
def api_status():
    """API —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–º–æ—â–Ω–∏–∫–∞"""
    if assistant_instance:
        return jsonify({
            "status": "online",
            "listening": assistant_instance.is_listening,
            "devices_count": len(assistant_instance.devices),
            "wake_words": assistant_instance.config.WAKE_WORDS
        })
    return jsonify({"status": "offline"})

@app.route('/api/devices')
def api_devices():
    """API —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"""
    if assistant_instance:
        return jsonify(assistant_instance.devices)
    return jsonify([])

@app.route('/api/speak', methods=['POST'])
def api_speak():
    """API –¥–ª—è –æ–∑–≤—É—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞"""
    data = request.json
    text = data.get('text', '')
    
    if assistant_instance and text:
        threading.Thread(
            target=assistant_instance.speak,
            args=(text,)
        ).start()
        return jsonify({"success": True})
    
    return jsonify({"success": False, "error": "No text provided"})

@app.route('/api/command', methods=['POST'])
def api_command():
    """API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã"""
    data = request.json
    command = data.get('command', '')
    
    if assistant_instance and command:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ OpenAI
        response = assistant_instance.process_with_openai(command)
        
        # –û–∑–≤—É—á–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        threading.Thread(
            target=assistant_instance.speak,
            args=(response,)
        ).start()
        
        return jsonify({
            "success": True,
            "response": response,
            "command": command
        })
    
    return jsonify({"success": False})

@app.route('/api/control', methods=['POST'])
def api_control():
    """API –¥–ª—è –ø—Ä—è–º–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º"""
    data = request.json
    device_id = data.get('device_id')
    command = data.get('command')
    
    if assistant_instance and device_id and command:
        assistant_instance.control_device(device_id, command)
        return jsonify({"success": True})
    
    return jsonify({"success": False})

def run_web_interface():
    """–ó–∞–ø—É—Å–∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
    app.run(host='0.0.0.0', port=8080, debug=False)

# ========== –û–°–ù–û–í–ù–û–ô –ë–õ–û–ö ==========

if __name__ == "__main__":
    print("""
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë      SystemHome Voice Assistant      ‚ïë
    ‚ïë       —Å OpenAI GPT –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π       ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
    if Config.OPENAI_API_KEY.startswith("sk-–≤–∞—à"):
        print("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à OpenAI API –∫–ª—é—á!")
        print("   –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞: https://platform.openai.com/api-keys")
        api_key = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è): ").strip()
        if api_key:
            Config.OPENAI_API_KEY = api_key
            print("‚úÖ –ö–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        else:
            print("‚ö†Ô∏è  –ë–µ–∑ API –∫–ª—é—á–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ò–ò –±—É–¥—É—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã")
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ –ø–æ–º–æ—â–Ω–∏–∫–∞
    assistant = VoiceAssistant()
    assistant_instance = assistant
    
    # –ó–∞–ø—É—Å–∫ –≤ –¥–≤—É—Ö –ø–æ—Ç–æ–∫–∞—Ö:
    # 1. –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫
    # 2. –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    voice_thread = threading.Thread(
        target=assistant.handle_conversation,
        daemon=True
    )
    
    web_thread = threading.Thread(
        target=run_web_interface,
        daemon=True
    )
    
    voice_thread.start()
    web_thread.start()
    
    print(f"\n‚úÖ –ü–æ–º–æ—â–Ω–∏–∫ –∑–∞–ø—É—â–µ–Ω!")
    print(f"   –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:8080")
    print(f"   –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: {', '.join(assistant.config.WAKE_WORDS)}")
    print(f"   –î–ª—è –≤—ã—Ö–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C\n")
    
    try:
        # –î–µ—Ä–∂–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã–º
        while assistant.is_running:
            time.sleep(1)
    except KeyboardInterrupt:
        assistant.stop()
        print("\nüëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã...")
