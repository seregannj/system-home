#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266HTTPClient.h>
#include <Adafruit_Sensor.h>
#include <DHT.h>
#include <DHT_U.h>

// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
const char* WIFI_SSID = "–í–ê–®_WIFI_SSID";
const char* WIFI_PASS = "–í–ê–®_WIFI_PASSWORD";

const char* SERVER_IP = "192.168.1.100";  // IP –≤–∞—à–µ–≥–æ –ü–ö —Å —Å–µ—Ä–≤–µ—Ä–æ–º
const int SERVER_PORT = 5000;

const char* DEVICE_ID = "temp_sensor_001";
const char* DEVICE_NAME = "–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã";
const char* DEVICE_TYPE = "sensor";

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∞—Ç—á–∏–∫–∞ DHT
#define DHTPIN D4          // GPIO2 (D4) –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–∞
#define DHTTYPE DHT22     // DHT22 (AM2302) –∏–ª–∏ DHT11

// –ü–∏–Ω—ã
const int STATUS_LED = D1;    // GPIO5 –¥–ª—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞
const int ERROR_LED = D2;     // GPIO4 –¥–ª—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞ –æ—à–∏–±–æ–∫

// –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã
const unsigned long MEASURE_INTERVAL = 30000;  // –ó–∞–º–µ—Ä –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
const unsigned long REPORT_INTERVAL = 60000;   // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
const unsigned long RETRY_INTERVAL = 10000;    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–µ
// ===============================

DHT_Unified dht(DHTPIN, DHTTYPE);
WiFiClient client;
HTTPClient http;

float temperature = 0;
float humidity = 0;
float heatIndex = 0;
bool sensorError = false;
unsigned long lastMeasure = 0;
unsigned long lastReport = 0;
unsigned long lastRetry = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n===== –¢–ï–ú–ü–ï–†–ê–¢–£–†–ù–´–ô –î–ê–¢–ß–ò–ö ESP8266 =====");
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
  pinMode(STATUS_LED, OUTPUT);
  pinMode(ERROR_LED, OUTPUT);
  digitalWrite(STATUS_LED, HIGH);  // –í—ã–∫–ª—é—á–µ–Ω
  digitalWrite(ERROR_LED, HIGH);   // –í—ã–∫–ª—é—á–µ–Ω
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–∞ DHT
  dht.begin();
  Serial.println("–î–∞—Ç—á–∏–∫ DHT –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  
  // –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–∞—Ç—á–∏–∫–µ
  sensor_t sensor;
  dht.temperature().getSensor(&sensor);
  Serial.println("=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç—á–∏–∫–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã ===");
  Serial.print("  –¢–∏–ø: "); Serial.println(sensor.name);
  Serial.print("  –ú–∞–∫—Å. –∑–Ω–∞—á–µ–Ω–∏–µ: "); Serial.print(sensor.max_value); Serial.println(" ¬∞C");
  Serial.print("  –ú–∏–Ω. –∑–Ω–∞—á–µ–Ω–∏–µ: "); Serial.print(sensor.min_value); Serial.println(" ¬∞C");
  Serial.print("  –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: "); Serial.print(sensor.resolution); Serial.println(" ¬∞C");
  
  dht.humidity().getSensor(&sensor);
  Serial.println("=== –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç—á–∏–∫–µ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ ===");
  Serial.print("  –¢–∏–ø: "); Serial.println(sensor.name);
  Serial.print("  –ú–∞–∫—Å. –∑–Ω–∞—á–µ–Ω–∏–µ: "); Serial.print(sensor.max_value); Serial.println(" %");
  Serial.print("  –ú–∏–Ω. –∑–Ω–∞—á–µ–Ω–∏–µ: "); Serial.print(sensor.min_value); Serial.println(" %");
  Serial.print("  –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: "); Serial.print(sensor.resolution); Serial.println(" %");
  Serial.println("======================================");
  
  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi
  connectToWiFi();
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  registerDevice();
  
  // –ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä
  measureSensor();
  
  Serial.println("–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ");
  Serial.println("=====================================\n");
}

void loop() {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WiFi
  if (WiFi.status() != WL_CONNECTED) {
    handleWiFiDisconnect();
  }
  
  // –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –∑–∞–º–µ—Ä—ã
  if (millis() - lastMeasure > MEASURE_INTERVAL) {
    measureSensor();
    lastMeasure = millis();
  }
  
  // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  if (millis() - lastReport > REPORT_INTERVAL) {
    if (!sensorError && WiFi.status() == WL_CONNECTED) {
      sendSensorData();
      lastReport = millis();
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–∞–Ω–¥ —Å —Å–µ—Ä–≤–µ—Ä–∞
  checkServerCommands();
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ü–∏–∏
  updateStatusLED();
  
  delay(100);
}

void connectToWiFi() {
  Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi: ");
  Serial.println(WIFI_SSID);
  
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  
  // –ò–Ω–¥–∏–∫–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  for (int i = 0; i < 15; i++) {
    if (WiFi.status() == WL_CONNECTED) break;
    digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
    delay(500);
    Serial.print(".");
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi –ø–æ–¥–∫–ª—é—á–µ–Ω!");
    Serial.print("IP –∞–¥—Ä–µ—Å: ");
    Serial.println(WiFi.localIP());
    Serial.print("–°–∏–≥–Ω–∞–ª: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
    digitalWrite(STATUS_LED, HIGH);
  } else {
    Serial.println("\n–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WiFi!");
    sensorError = true;
  }
}

void handleWiFiDisconnect() {
  static unsigned long lastDisconnect = 0;
  
  if (millis() - lastRetry > RETRY_INTERVAL) {
    Serial.println("–ü–æ—Ç–µ—Ä—è–Ω–æ WiFi —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");
    digitalWrite(STATUS_LED, LOW);
    digitalWrite(ERROR_LED, LOW);
    
    WiFi.disconnect();
    delay(1000);
    WiFi.begin(WIFI_SSID, WIFI_PASS);
    
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 10) {
      delay(500);
      digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
      attempts++;
    }
    
    if (WiFi.status() == WL_CONNECTED) {
      Serial.println("WiFi –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
      digitalWrite(STATUS_LED, HIGH);
      digitalWrite(ERROR_LED, HIGH);
      sensorError = false;
    } else {
      Serial.println("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WiFi");
      sensorError = true;
    }
    
    lastRetry = millis();
  }
}

void registerDevice() {
  Serial.println("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–∞—Ç—á–∏–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...");
  
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/register";
  
  http.begin(client, serverURL);
  http.addHeader("Content-Type", "application/json");
  
  // JSON –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  String jsonData = "{";
  jsonData += "\"id\":\"" + String(DEVICE_ID) + "\",";
  jsonData += "\"name\":\"" + String(DEVICE_NAME) + "\",";
  jsonData += "\"type\":\"sensor\",";
  jsonData += "\"icon\":\"üå°Ô∏è\",";
  jsonData += "\"description\":\"–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ DHT22\",";
  jsonData += "\"commands\":[\"read\",\"calibrate\",\"reset\"],";
  jsonData += "\"parameters\":{";
  jsonData += "\"temperature\":{\"unit\":\"¬∞C\",\"min\":-40,\"max\":80},";
  jsonData += "\"humidity\":{\"unit\":\"%\",\"min\":0,\"max\":100}";
  jsonData += "}";
  jsonData += "}";
  
  int httpCode = http.POST(jsonData);
  
  if (httpCode > 0) {
    Serial.print("–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ");
    Serial.println(httpCode);
    
    if (httpCode == HTTP_CODE_OK) {
      Serial.println("–î–∞—Ç—á–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
      sendStatus("online");
    }
  } else {
    Serial.print("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ");
    Serial.println(http.errorToString(httpCode).c_str());
    sensorError = true;
  }
  
  http.end();
}

void measureSensor() {
  Serial.println("=== –ó–∞–º–µ—Ä –ø–æ–∫–∞–∑–∞–Ω–∏–π ===");
  
  // –ó–∞–º–µ—Ä —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
  sensors_event_t event;
  dht.temperature().getEvent(&event);
  
  if (isnan(event.temperature)) {
    Serial.println("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã!");
    sensorError = true;
    digitalWrite(ERROR_LED, LOW);
  } else {
    temperature = event.temperature;
    Serial.print("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ");
    Serial.print(temperature);
    Serial.println(" ¬∞C");
    sensorError = false;
    digitalWrite(ERROR_LED, HIGH);
  }
  
  // –ó–∞–º–µ—Ä –≤–ª–∞–∂–Ω–æ—Å—Ç–∏
  dht.humidity().getEvent(&event);
  
  if (isnan(event.relative_humidity)) {
    Serial.println("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤–ª–∞–∂–Ω–æ—Å—Ç–∏!");
    sensorError = true;
    digitalWrite(ERROR_LED, LOW);
  } else {
    humidity = event.relative_humidity;
    Serial.print("–í–ª–∞–∂–Ω–æ—Å—Ç—å: ");
    Serial.print(humidity);
    Serial.println(" %");
    sensorError = false;
    digitalWrite(ERROR_LED, HIGH);
  }
  
  // –†–∞—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ —Ç–µ–ø–ª–∞ (Heat Index)
  if (!isnan(temperature) && !isnan(humidity)) {
    heatIndex = calculateHeatIndex(temperature, humidity);
    Serial.print("–ò–Ω–¥–µ–∫—Å —Ç–µ–ø–ª–∞: ");
    Serial.print(heatIndex);
    Serial.println(" ¬∞C");
  }
  
  // –û—Ü–µ–Ω–∫–∞ –∫–æ–º—Ñ–æ—Ä—Ç–∞
  evaluateComfort(temperature, humidity);
  
  Serial.println("=======================");
}

float calculateHeatIndex(float t, float h) {
  // –†–∞—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ —Ç–µ–ø–ª–∞ (Heat Index) –ø–æ —Ñ–æ—Ä–º—É–ª–µ –†–æ–±–µ—Ä—Ç–∞ –ì. –°—Ç–µ–¥–º–∞–Ω–∞
  if (t < 27.0 || h < 40.0) {
    return t;  // –§–æ—Ä–º—É–ª–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –¥–ª—è t > 27¬∞C –∏ h > 40%
  }
  
  float c1 = -8.78469475556;
  float c2 = 1.61139411;
  float c3 = 2.33854883889;
  float c4 = -0.14611605;
  float c5 = -0.012308094;
  float c6 = -0.0164248277778;
  float c7 = 0.002211732;
  float c8 = 0.00072546;
  float c9 = -0.000003582;
  
  float T = t;
  float R = h;
  
  float HI = c1 + c2*T + c3*R + c4*T*R + c5*T*T + c6*R*R + c7*T*T*R + c8*T*R*R + c9*T*T*R*R;
  
  return HI;
}

void evaluateComfort(float temp, float hum) {
  Serial.print("–û—Ü–µ–Ω–∫–∞ –∫–æ–º—Ñ–æ—Ä—Ç–∞: ");
  
  if (temp >= 20 && temp <= 25 && hum >= 30 && hum <= 60) {
    Serial.println("–ò–¥–µ–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è ‚úì");
  } else if (temp < 18) {
    Serial.println("–ü—Ä–æ—Ö–ª–∞–¥–Ω–æ, –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –æ–±–æ–≥—Ä–µ–≤");
  } else if (temp > 27) {
    Serial.println("–ñ–∞—Ä–∫–æ, –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä");
  } else if (hum < 30) {
    Serial.println("–°—É—Ö–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–≤–ª–∞–∂–Ω–∏—Ç–µ–ª—å");
  } else if (hum > 70) {
    Serial.println("–í–ª–∞–∂–Ω–æ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ç—Ä–∏—Ç—å");
  } else {
    Serial.println("–£—Å–ª–æ–≤–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã");
  }
}

void sendSensorData() {
  if (sensorError) {
    Serial.println("–û—à–∏–±–∫–∞ –¥–∞—Ç—á–∏–∫–∞ - –¥–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è");
    return;
  }
  
  Serial.println("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");
  
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/sensor_data";
  
  http.begin(client, serverURL);
  http.addHeader("Content-Type", "application/json");
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º JSON —Å –¥–∞–Ω–Ω—ã–º–∏
  String jsonData = "{";
  jsonData += "\"device_id\":\"" + String(DEVICE_ID) + "\",";
  jsonData += "\"temperature\":" + String(temperature, 1) + ",";
  jsonData += "\"humidity\":" + String(humidity, 1) + ",";
  jsonData += "\"heat_index\":" + String(heatIndex, 1) + ",";
  jsonData += "\"timestamp\":" + String(millis()) + ",";
  jsonData += "\"rssi\":" + String(WiFi.RSSI());
  jsonData += "}";
  
  int httpCode = http.POST(jsonData);
  
  if (httpCode > 0) {
    Serial.print("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: ");
    Serial.println(httpCode);
    
    if (httpCode == HTTP_CODE_OK) {
      String response = http.getString();
      Serial.println("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: " + response);
    }
  } else {
    Serial.print("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ");
    Serial.println(http.errorToString(httpCode).c_str());
  }
  
  http.end();
  
  // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  String status = String(temperature, 1) + "C/" + String(humidity, 1) + "%";
  sendStatus(status);
}

void sendStatus(String status) {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/update_status/" + String(DEVICE_ID) + "/" + status;
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    Serial.println("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: " + status);
  }
  
  http.end();
}

void checkServerCommands() {
  static unsigned long lastCheck = 0;
  
  if (millis() - lastCheck > 5000) {  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/command/" + String(DEVICE_ID) + "/check";
    
    http.begin(client, serverURL);
    int httpCode = http.GET();
    
    if (httpCode == HTTP_CODE_OK) {
      String command = http.getString();
      command.trim();
      
      if (command.length() > 0) {
        Serial.print("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞: ");
        Serial.println(command);
        
        processCommand(command);
      }
    }
    
    http.end();
    lastCheck = millis();
  }
}

void processCommand(String command) {
  if (command == "read") {
    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–º–µ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    measureSensor();
    sendSensorData();
    sendStatus("read_ok");
    
  } else if (command == "calibrate") {
    // –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ (–∑–∞–≥–ª—É—à–∫–∞)
    Serial.println("–ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –¥–∞—Ç—á–∏–∫–∞...");
    sendStatus("calibrating");
    delay(1000);
    sendStatus("calibrated");
    
  } else if (command == "reset") {
    // –°–±—Ä–æ—Å –¥–∞—Ç—á–∏–∫–∞
    Serial.println("–°–±—Ä–æ—Å –¥–∞—Ç—á–∏–∫–∞...");
    sendStatus("resetting");
    ESP.restart();
    
  } else if (command.startsWith("interval:")) {
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    int newInterval = command.substring(9).toInt();
    if (newInterval >= 10000 && newInterval <= 300000) {
      REPORT_INTERVAL = newInterval;
      Serial.print("–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ");
      Serial.println(REPORT_INTERVAL);
      sendStatus("interval_changed");
    }
  }
}

void updateStatusLED() {
  static unsigned long lastBlink = 0;
  
  if (sensorError) {
    // –ë—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    if (millis() - lastBlink > 200) {
      digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
      lastBlink = millis();
    }
  } else if (WiFi.status() == WL_CONNECTED) {
    // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ
    if (millis() - lastBlink > 2000) {
      digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
      lastBlink = millis();
    }
  } else {
    // –í—ã–∫–ª—é—á–µ–Ω –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ WiFi
    digitalWrite(STATUS_LED, HIGH);
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Serial
void handleSerialCommands() {
  if (Serial.available() > 0) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    
    if (cmd == "measure") {
      measureSensor();
    } else if (cmd == "send") {
      sendSensorData();
    } else if (cmd == "status") {
      Serial.println("=== –°–¢–ê–¢–£–° –î–ê–¢–ß–ò–ö–ê ===");
      Serial.print("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: "); Serial.print(temperature); Serial.println(" ¬∞C");
      Serial.print("–í–ª–∞–∂–Ω–æ—Å—Ç—å: "); Serial.print(humidity); Serial.println(" %");
      Serial.print("–ò–Ω–¥–µ–∫—Å —Ç–µ–ø–ª–∞: "); Serial.print(heatIndex); Serial.println(" ¬∞C");
      Serial.print("–û—à–∏–±–∫–∞ –¥–∞—Ç—á–∏–∫–∞: "); Serial.println(sensorError ? "–î–ê" : "–ù–ï–¢");
      Serial.print("WiFi: "); Serial.println(WiFi.status() == WL_CONNECTED ? "–ü–æ–¥–∫–ª—é—á–µ–Ω" : "–û—Ç–∫–ª—é—á–µ–Ω");
      if (WiFi.status() == WL_CONNECTED) {
        Serial.print("IP: "); Serial.println(WiFi.localIP());
        Serial.print("RSSI: "); Serial.print(WiFi.RSSI()); Serial.println(" dBm");
      }
      Serial.println("====================");
    } else if (cmd == "wifi") {
      connectToWiFi();
    } else if (cmd == "help") {
      Serial.println("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:");
      Serial.println("  measure  - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–º–µ—Ä");
      Serial.println("  send     - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä");
      Serial.println("  status   - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞—Ç—á–∏–∫–µ");
      Serial.println("  wifi     - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WiFi");
      Serial.println("  help     - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞");
    }
  }
}
