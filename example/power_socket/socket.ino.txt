#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266HTTPClient.h>

// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
const char* WIFI_SSID = "–í–ê–®_WIFI_SSID";
const char* WIFI_PASS = "–í–ê–®_WIFI_PASSWORD";

const char* SERVER_IP = "192.168.1.100";  // IP –≤–∞—à–µ–≥–æ –ü–ö —Å —Å–µ—Ä–≤–µ—Ä–æ–º
const int SERVER_PORT = 5000;

const char* DEVICE_ID = "smart_socket_001";
const char* DEVICE_NAME = "–£–º–Ω–∞—è —Ä–æ–∑–µ—Ç–∫–∞";
const char* DEVICE_TYPE = "switch";

const int RELAY_PIN = D1;      // GPIO5 –¥–ª—è —Ä–µ–ª–µ (–≤–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ)
const int LED_PIN = D4;        // GPIO2 –¥–ª—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞ (D4 = –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π LED)
const int BUTTON_PIN = D3;     // GPIO0 –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

// –î–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç—á–∏–∫ —Ç–æ–∫–∞)
// const int CURRENT_PIN = A0;
// ===============================

WiFiClient client;
HTTPClient http;
bool socketState = false;      // false = –≤—ã–∫–ª—é—á–µ–Ω–æ, true = –≤–∫–ª—é—á–µ–Ω–æ
bool lastButtonState = HIGH;
unsigned long lastCheck = 0;
const unsigned long CHECK_INTERVAL = 1000;
unsigned long lastDebounceTime = 0;
const unsigned long DEBOUNCE_DELAY = 50;

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n===== SMART SOCKET ESP8266 =====");
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
  pinMode(RELAY_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è - —Ä–æ–∑–µ—Ç–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞
  digitalWrite(RELAY_PIN, LOW);
  digitalWrite(LED_PIN, HIGH);  // LED –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ D4
  
  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi
  connectToWiFi();
  
  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
  registerDevice();
  
  Serial.println("–£–º–Ω–∞—è —Ä–æ–∑–µ—Ç–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ");
  Serial.println("===============================\n");
}

void loop() {
  // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å WiFi
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("–ü–æ—Ç–µ—Ä—è–Ω–æ WiFi —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...");
    digitalWrite(LED_PIN, LOW);  // –ë—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏
    delay(100);
    digitalWrite(LED_PIN, HIGH);
    connectToWiFi();
  } else {
    // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –º–∏–≥–∞–Ω–∏–µ –∫–æ–≥–¥–∞ –æ–Ω–ª–∞–π–Ω –∏ –≤—ã–∫–ª—é—á–µ–Ω–æ
    if (!socketState) {
      static unsigned long lastBlink = 0;
      if (millis() - lastBlink > 2000) {
        digitalWrite(LED_PIN, LOW);
        delay(50);
        digitalWrite(LED_PIN, HIGH);
        lastBlink = millis();
      }
    } else {
      digitalWrite(LED_PIN, LOW);  // –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –≥–æ—Ä–∏—Ç –∫–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ
    }
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏ (—Ä—É—á–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
  checkButton();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
  if (millis() - lastCheck > CHECK_INTERVAL) {
    checkForCommands();
    lastCheck = millis();
  }
  
  delay(10);
}

void connectToWiFi() {
  Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi: ");
  Serial.println(WIFI_SSID);
  
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  
  // –ë—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ LED –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
  for (int i = 0; i < 20; i++) {
    digitalWrite(LED_PIN, !digitalRead(LED_PIN));
    delay(100);
  }
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    digitalWrite(LED_PIN, !digitalRead(LED_PIN));
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nWiFi –ø–æ–¥–∫–ª—é—á–µ–Ω!");
    Serial.print("IP –∞–¥—Ä–µ—Å: ");
    Serial.println(WiFi.localIP());
    digitalWrite(LED_PIN, HIGH);  // –í—ã–∫–ª—é—á–∏—Ç—å LED
  } else {
    Serial.println("\n–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ WiFi!");
  }
}

void registerDevice() {
  Serial.println("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–æ–∑–µ—Ç–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...");
  
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/register";
  
  http.begin(client, serverURL);
  http.addHeader("Content-Type", "application/json");
  
  // JSON –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  String jsonData = "{";
  jsonData += "\"id\":\"" + String(DEVICE_ID) + "\",";
  jsonData += "\"name\":\"" + String(DEVICE_NAME) + "\",";
  jsonData += "\"type\":\"" + String(DEVICE_TYPE) + "\",";
  jsonData += "\"icon\":\"üîå\",";
  jsonData += "\"description\":\"–£–º–Ω–∞—è Wi-Fi —Ä–æ–∑–µ—Ç–∫–∞ 220V/10A\",";
  jsonData += "\"commands\":[\"on\",\"off\",\"toggle\"]";
  jsonData += "}";
  
  int httpCode = http.POST(jsonData);
  
  if (httpCode > 0) {
    Serial.print("–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ");
    Serial.println(httpCode);
    
    if (httpCode == HTTP_CODE_OK) {
      Serial.println("–†–æ–∑–µ—Ç–∫–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
      
      // –°–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      sendStatus("off");
    }
  } else {
    Serial.print("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ");
    Serial.println(http.errorToString(httpCode).c_str());
  }
  
  http.end();
}

void checkForCommands() {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/command/" + String(DEVICE_ID) + "/check";
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    String command = http.getString();
    command.trim();
    
    if (command.length() > 0) {
      Serial.print("–ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞: ");
      Serial.println(command);
      
      processCommand(command);
    }
  }
  
  http.end();
}

void processCommand(String command) {
  if (command == "on") {
    turnOn();
  } else if (command == "off") {
    turnOff();
  } else if (command == "toggle") {
    toggle();
  }
}

void turnOn() {
  digitalWrite(RELAY_PIN, HIGH);
  socketState = true;
  digitalWrite(LED_PIN, LOW);  // LED –≤–∫–ª—é—á–µ–Ω –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ
  Serial.println("–†–æ–∑–µ—Ç–∫–∞: –í–ö–õ–Æ–ß–ï–ù–ê");
  sendStatus("on");
  
  // –ó–≤—É–∫–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–∏—â–∞–ª–∫–∞)
  beep(100);
}

void turnOff() {
  digitalWrite(RELAY_PIN, LOW);
  socketState = false;
  digitalWrite(LED_PIN, HIGH);  // LED –≤—ã–∫–ª—é—á–µ–Ω
  Serial.println("–†–æ–∑–µ—Ç–∫–∞: –í–´–ö–õ–Æ–ß–ï–ù–ê");
  sendStatus("off");
  
  // –ó–≤—É–∫–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
  beep(50);
  delay(50);
  beep(50);
}

void toggle() {
  if (socketState) {
    turnOff();
  } else {
    turnOn();
  }
}

void sendStatus(String status) {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/update_status/" + String(DEVICE_ID) + "/" + status;
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    Serial.println("–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä: " + status);
  }
  
  http.end();
}

void checkButton() {
  int reading = digitalRead(BUTTON_PIN);
  
  if (reading != lastButtonState) {
    lastDebounceTime = millis();
  }
  
  if ((millis() - lastDebounceTime) > DEBOUNCE_DELAY) {
    if (reading == LOW) {  // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ (–ø–æ–¥—Ç—è–∂–∫–∞ –∫ HIGH)
      Serial.println("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ–∑–µ—Ç–∫–∏");
      toggle();
      delay(300);  // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—Ä–µ–±–µ–∑–≥–∞
    }
  }
  
  lastButtonState = reading;
}

void beep(int duration) {
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∏—â–∞–ª–∫–∏ (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ D2)
  // pinMode(D2, OUTPUT);
  // digitalWrite(D2, HIGH);
  // delay(duration);
  // digitalWrite(D2, LOW);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç—á–∏–∫ —Ç–æ–∫–∞ ACS712)
/*
void measurePower() {
  int sensorValue = analogRead(CURRENT_PIN);
  float voltage = sensorValue * (3.3 / 1023.0);
  float current = (voltage - 2.5) / 0.066;  // –î–ª—è ACS712 5A
  float power = current * 220.0;  // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º 220V
  
  if (socketState && abs(current) > 0.1) {  // –¢–æ–∫ –±–æ–ª—å—à–µ 0.1A
    Serial.print("–¢–æ–∫: ");
    Serial.print(current, 2);
    Serial.print("A, –ú–æ—â–Ω–æ—Å—Ç—å: ");
    Serial.print(power, 0);
    Serial.println("W");
  }
}
*/

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Serial
void handleSerialCommands() {
  if (Serial.available() > 0) {
    String cmd = Serial.readStringUntil('\n');
    cmd.trim();
    
    if (cmd == "on") turnOn();
    else if (cmd == "off") turnOff();
    else if (cmd == "toggle") toggle();
    else if (cmd == "status") {
      Serial.println("=== –°–¢–ê–¢–£–° –†–û–ó–ï–¢–ö–ò ===");
      Serial.print("–°–æ—Å—Ç–æ—è–Ω–∏–µ: ");
      Serial.println(socketState ? "–í–ö–õ–Æ–ß–ï–ù–ê" : "–í–´–ö–õ–Æ–ß–ï–ù–ê");
      Serial.print("WiFi: ");
      Serial.println(WiFi.status() == WL_CONNECTED ? "–ü–æ–¥–∫–ª—é—á–µ–Ω" : "–û—Ç–∫–ª—é—á–µ–Ω");
      if (WiFi.status() == WL_CONNECTED) {
        Serial.print("IP: ");
        Serial.println(WiFi.localIP());
        Serial.print("RSSI: ");
        Serial.print(WiFi.RSSI());
        Serial.println(" dBm");
      }
      Serial.println("======================");
    }
    else if (cmd == "reboot") {
      Serial.println("–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ ESP...");
      ESP.restart();
    }
    else if (cmd == "help") {
      Serial.println("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:");
      Serial.println("  on     - –≤–∫–ª—é—á–∏—Ç—å —Ä–æ–∑–µ—Ç–∫—É");
      Serial.println("  off    - –≤—ã–∫–ª—é—á–∏—Ç—å —Ä–æ–∑–µ—Ç–∫—É");
      Serial.println("  toggle - –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å");
      Serial.println("  status - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è");
      Serial.println("  reboot - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞");
      Serial.println("  help   - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞");
    }
  }
}
