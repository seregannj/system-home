from flask import Flask, render_template, jsonify, request
import sqlite3
import json
import os
from datetime import datetime

app = Flask(__name__)
DATABASE = 'devices.db'
DEVICES_CONFIG_DIR = 'devices_config'

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
os.makedirs(DEVICES_CONFIG_DIR, exist_ok=True)

def init_db():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS devices (
            id TEXT PRIMARY KEY,
            name TEXT NOT NULL,
            type TEXT NOT NULL,
            status TEXT DEFAULT 'offline',
            last_seen TIMESTAMP,
            config_file TEXT
        )
    ''')
    conn.commit()
    conn.close()

def save_device_config(device_id, config):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ JSON"""
    config_file = os.path.join(DEVICES_CONFIG_DIR, f"{device_id}.json")
    with open(config_file, 'w', encoding='utf-8') as f:
        json.dump(config, f, ensure_ascii=False, indent=2)
    return config_file

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º"""
    return render_template('index.html')

@app.route('/devices')
def get_devices():
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å –∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    cursor.execute('SELECT id, name, type, status, config_file FROM devices')
    devices_data = cursor.fetchall()
    
    devices = []
    for device in devices_data:
        device_id, name, type_, status, config_file = device
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ JSON
        config = {}
        if config_file and os.path.exists(config_file):
            with open(config_file, 'r', encoding='utf-8') as f:
                config = json.load(f)
        
        devices.append({
            'id': device_id,
            'name': name,
            'type': type_,
            'status': status,
            'config': config
        })
    
    conn.close()
    return jsonify(devices)

@app.route('/register', methods=['POST'])
def register_device():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"""
    data = request.json
    
    if not data or 'id' not in data:
        return jsonify({'error': 'No device ID provided'}), 400
    
    device_id = data['id']
    name = data.get('name', f'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ {device_id}')
    device_type = data.get('type', 'unknown')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    config = {
        'id': device_id,
        'name': name,
        'type': device_type,
        'icon': data.get('icon', 'üí°'),
        'description': data.get('description', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–º–Ω–æ–≥–æ –¥–æ–º–∞'),
        'commands': data.get('commands', ['on', 'off']),
        'status_options': data.get('status_options', ['on', 'off'])
    }
    
    config_file = save_device_config(device_id, config)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    
    cursor.execute('''
        INSERT OR REPLACE INTO devices (id, name, type, status, last_seen, config_file)
        VALUES (?, ?, ?, ?, ?, ?)
    ''', (device_id, name, device_type, 'online', datetime.now(), config_file))
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True, 'message': f'–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ {name} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ'})

@app.route('/command//')
def send_command(device_id, command):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    cursor.execute('SELECT name, config_file FROM devices WHERE id = ?', (device_id,))
    device = cursor.fetchone()
    
    if not device:
        return jsonify({'error': '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}), 404
    
    device_name, config_file = device
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    new_status = command if command in ['online', 'offline'] else 'online'
    cursor.execute(
        'UPDATE devices SET status = ?, last_seen = ? WHERE id = ?',
        (new_status, datetime.now(), device_id)
    )
    
    conn.commit()
    conn.close()
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—ã–ª –±—ã –≤—ã–∑–æ–≤ API —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    # –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
    return jsonify({
        'success': True,
        'message': f'–ö–æ–º–∞–Ω–¥–∞ "{command}" –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É "{device_name}"',
        'device_id': device_id,
        'command': command
    })

@app.route('/update_status//')
def update_status(device_id, status):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞)"""
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    
    cursor.execute(
        'UPDATE devices SET status = ?, last_seen = ? WHERE id = ?',
        (status, datetime.now(), device_id)
    )
    
    conn.commit()
    conn.close()
    
    return jsonify({'success': True})

if __name__ == '__main__':
    init_db()
    print("–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ http://127.0.0.1:5000")
    print("–î–æ–±–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ POST –∑–∞–ø—Ä–æ—Å –Ω–∞ /register")
    app.run(debug=True, host='0.0.0.0', port=5000)
