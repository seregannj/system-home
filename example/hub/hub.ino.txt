#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266HTTPClient.h>
#include <ESP8266WebServer.h>

// ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
const char* MAIN_WIFI_SSID = "–í–ê–®_–û–°–ù–û–í–ù–û–ô_WIFI";
const char* MAIN_WIFI_PASS = "–í–ê–®_–ü–ê–†–û–õ–¨";

const char* HUB_WIFI_SSID = "SmartHome_Hub";    // –ò–º—è —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞ —Ö–∞–±–∞
const char* HUB_WIFI_PASS = "homehub123";       // –ü–∞—Ä–æ–ª—å —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞

const char* SERVER_IP = "192.168.1.100";        // IP —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
const int SERVER_PORT = 5000;

const char* HUB_ID = "wifi_hub_001";
const char* HUB_NAME = "Wi-Fi –•–∞–±";
const char* HUB_TYPE = "hub";

const int STATUS_LED = D4;          // GPIO2 –¥–ª—è —Å–≤–µ—Ç–æ–¥–∏–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞
const int BUTTON_PIN = D3;          // GPIO0 –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞

// –î–∏–∞–ø–∞–∑–æ–Ω IP –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
IPAddress local_IP(192, 168, 4, 1);
IPAddress gateway(192, 168, 4, 1);
IPAddress subnet(255, 255, 255, 0);
// ===============================

ESP8266WebServer webServer(80);
WiFiClient client;
HTTPClient http;

bool hubMode = true;                // true = —Ä–µ–∂–∏–º —Ö–∞–±–∞, false = –∫–ª–∏–µ–Ω—Ç
unsigned long lastStatusUpdate = 0;
const unsigned long STATUS_INTERVAL = 5000;
int connectedDevices = 0;

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n===== SMART HOME Wi-Fi HUB =====");
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∏–Ω–æ–≤
  pinMode(STATUS_LED, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  digitalWrite(STATUS_LED, HIGH);
  
  // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  if (digitalRead(BUTTON_PIN) == LOW) {
    Serial.println("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ - —Å–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫");
    factoryReset();
  }
  
  // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∏
  if (connectToMainWiFi()) {
    Serial.println("–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∏ Wi-Fi");
    hubMode = false;  // –†–∞–±–æ—Ç–∞–µ–º –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç
    registerHub();
  } else {
    Serial.println("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∏");
    Serial.println("–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ Wi-Fi –•–∞–±–∞...");
    startWiFiHub();
    hubMode = true;
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  setupWebServer();
  
  Serial.println("–•–∞–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");
  Serial.println("===============================\n");
}

void loop() {
  // –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
  webServer.handleClient();
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏
  checkButton();
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
  if (!hubMode && millis() - lastStatusUpdate > STATUS_INTERVAL) {
    updateHubStatus();
    lastStatusUpdate = millis();
  }
  
  // –í —Ä–µ–∂–∏–º–µ —Ö–∞–±–∞ —Å–∫–∞–Ω–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  if (hubMode) {
    updateConnectedDevices();
  }
  
  // –ú–∏–≥–∞–Ω–∏–µ —Å–≤–µ—Ç–æ–¥–∏–æ–¥–æ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
  updateStatusLED();
  
  delay(10);
}

bool connectToMainWiFi() {
  Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–∏: ");
  Serial.println(MAIN_WIFI_SSID);
  
  WiFi.begin(MAIN_WIFI_SSID, MAIN_WIFI_PASS);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\n–£—Å–ø–µ—à–Ω–æ!");
    Serial.print("IP –∞–¥—Ä–µ—Å: ");
    Serial.println(WiFi.localIP());
    digitalWrite(STATUS_LED, HIGH);
    return true;
  }
  
  Serial.println("\n–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è");
  digitalWrite(STATUS_LED, LOW);
  return false;
}

void startWiFiHub() {
  Serial.println("–°–æ–∑–¥–∞–Ω–∏–µ —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞ Wi-Fi...");
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞
  WiFi.mode(WIFI_AP);
  WiFi.softAPConfig(local_IP, gateway, subnet);
  
  if (WiFi.softAP(HUB_WIFI_SSID, HUB_WIFI_PASS)) {
    Serial.println("–¢–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —Å–æ–∑–¥–∞–Ω–∞!");
    Serial.print("SSID: ");
    Serial.println(HUB_WIFI_SSID);
    Serial.print("IP –∞–¥—Ä–µ—Å —Ö–∞–±–∞: ");
    Serial.println(WiFi.softAPIP());
    Serial.print("–ü–∞—Ä–æ–ª—å: ");
    Serial.println(HUB_WIFI_PASS);
    
    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ö–∞–± –≤ —Ä–µ–∂–∏–º–µ AP
    registerHub();
  } else {
    Serial.println("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞!");
  }
}

void registerHub() {
  Serial.println("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö–∞–±–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...");
  
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/register";
  
  http.begin(client, serverURL);
  http.addHeader("Content-Type", "application/json");
  
  // JSON –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  String jsonData = "{";
  jsonData += "\"id\":\"" + String(HUB_ID) + "\",";
  jsonData += "\"name\":\"" + String(HUB_NAME) + "\",";
  jsonData += "\"type\":\"" + String(HUB_TYPE) + "\",";
  jsonData += "\"icon\":\"üì°\",";
  jsonData += "\"description\":\"Wi-Fi –•–∞–± –¥–ª—è —É–º–Ω–æ–≥–æ –¥–æ–º–∞\",";
  jsonData += "\"commands\":[\"scan\",\"restart\",\"mode\"],";
  jsonData += "\"status\":\"" + String(hubMode ? "hub" : "client") + "\"";
  jsonData += "}";
  
  int httpCode = http.POST(jsonData);
  
  if (httpCode > 0) {
    Serial.print("–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ");
    Serial.println(httpCode);
    
    if (httpCode == HTTP_CODE_OK) {
      Serial.println("–•–∞–± –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!");
      sendStatus(hubMode ? "hub" : "client");
    }
  } else {
    Serial.print("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ");
    Serial.println(http.errorToString(httpCode).c_str());
  }
  
  http.end();
}

void updateHubStatus() {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ö–∞–±–∞
  String status = String(hubMode ? "hub" : "client") + "_devices:" + String(connectedDevices);
  sendStatus(status);
}

void sendStatus(String status) {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/update_status/" + String(HUB_ID) + "/" + status;
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    Serial.println("–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: " + status);
  }
  
  http.end();
}

void checkButton() {
  static unsigned long lastPress = 0;
  
  if (digitalRead(BUTTON_PIN) == LOW && millis() - lastPress > 1000) {
    Serial.println("–î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞");
    lastPress = millis();
    
    if (hubMode) {
      // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞
      if (connectToMainWiFi()) {
        hubMode = false;
        registerHub();
        Serial.println("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ —Ä–µ–∂–∏–º –∫–ª–∏–µ–Ω—Ç–∞");
      }
    } else {
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º —Ö–∞–±–∞
      WiFi.disconnect();
      delay(1000);
      startWiFiHub();
      hubMode = true;
      Serial.println("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –≤ —Ä–µ–∂–∏–º —Ö–∞–±–∞");
    }
  }
}

void updateConnectedDevices() {
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∫ —Ç–æ—á–∫–µ –¥–æ—Å—Ç—É–ø–∞
  int newCount = WiFi.softAPgetStationNum();
  
  if (newCount != connectedDevices) {
    connectedDevices = newCount;
    Serial.print("–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ");
    Serial.println(connectedDevices);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    sendStatus("hub_devices:" + String(connectedDevices));
  }
}

void updateStatusLED() {
  static unsigned long lastBlink = 0;
  
  if (hubMode) {
    // –í —Ä–µ–∂–∏–º–µ —Ö–∞–±–∞: –º–µ–¥–ª–µ–Ω–Ω–æ–µ –º–∏–≥–∞–Ω–∏–µ
    if (millis() - lastBlink > (connectedDevices > 0 ? 2000 : 1000)) {
      digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
      lastBlink = millis();
    }
  } else {
    // –í —Ä–µ–∂–∏–º–µ –∫–ª–∏–µ–Ω—Ç–∞: –±—ã—Å—Ç—Ä–æ–µ –º–∏–≥–∞–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö, –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø—Ä–∏ OK
    if (WiFi.status() != WL_CONNECTED) {
      if (millis() - lastBlink > 200) {
        digitalWrite(STATUS_LED, !digitalRead(STATUS_LED));
        lastBlink = millis();
      }
    } else {
      digitalWrite(STATUS_LED, LOW);  // –ü–æ—Å—Ç–æ—è–Ω–Ω–æ –≥–æ—Ä–∏—Ç –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    }
  }
}

void setupWebServer() {
  // –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ö–∞–±–æ–º
  webServer.on("/", HTTP_GET, []() {
    String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'>";
    html += "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
    html += "<title>SmartHome Hub</title><style>";
    html += "body{font-family:Arial,sans-serif;margin:20px;background:#f0f0f0;}";
    html += ".card{background:white;padding:20px;border-radius:10px;margin:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}";
    html += ".hub{background:#4CAF50;color:white;}";
    html += ".client{background:#2196F3;color:white;}";
    html += "button{padding:10px 20px;margin:5px;border:none;border-radius:5px;cursor:pointer;}";
    html += "</style></head><body>";
    html += "<div class='card " + String(hubMode ? "hub" : "client") + "'>";
    html += "<h1>SmartHome Wi-Fi –•–∞–±</h1>";
    html += "<p><strong>–†–µ–∂–∏–º:</strong> " + String(hubMode ? "Wi-Fi –•–∞–± (–¢–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞)" : "Wi-Fi –ö–ª–∏–µ–Ω—Ç") + "</p>";
    html += "<p><strong>ID:</strong> " + String(HUB_ID) + "</p>";
    
    if (hubMode) {
      html += "<p><strong>SSID:</strong> " + String(HUB_WIFI_SSID) + "</p>";
      html += "<p><strong>–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:</strong> " + String(connectedDevices) + "</p>";
      html += "<p><strong>IP —Ö–∞–±–∞:</strong> " + WiFi.softAPIP().toString() + "</p>";
    } else {
      html += "<p><strong>–ü–æ–¥–∫–ª—é—á–µ–Ω –∫:</strong> " + String(MAIN_WIFI_SSID) + "</p>";
      html += "<p><strong>IP –∞–¥—Ä–µ—Å:</strong> " + WiFi.localIP().toString() + "</p>";
      html += "<p><strong>–°–∏–≥–Ω–∞–ª:</strong> " + String(WiFi.RSSI()) + " dBm</p>";
    }
    
    html += "</div>";
    
    html += "<div class='card'>";
    html += "<h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>";
    html += "<button onclick=\"location.href='/scan'\">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∏</button>";
    html += "<button onclick=\"location.href='/switch'\">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º</button>";
    html += "<button onclick=\"location.href='/restart'\">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>";
    html += "<button onclick=\"location.href='/status'\">–°—Ç–∞—Ç—É—Å</button>";
    html += "</div>";
    
    html += "</body></html>";
    webServer.send(200, "text/html", html);
  });
  
  webServer.on("/scan", HTTP_GET, []() {
    String html = "<html><body><h1>–î–æ—Å—Ç—É–ø–Ω—ã–µ Wi-Fi —Å–µ—Ç–∏:</h1><ul>";
    
    int n = WiFi.scanNetworks();
    for (int i = 0; i < n; i++) {
      html += "<li>" + WiFi.SSID(i) + " (–°–∏–≥–Ω–∞–ª: " + WiFi.RSSI(i) + " dBm)</li>";
    }
    
    html += "</ul><br><a href='/'>–ù–∞–∑–∞–¥</a></body></html>";
    webServer.send(200, "text/html", html);
  });
  
  webServer.on("/switch", HTTP_GET, []() {
    String html = "<html><body><h1>–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞...</h1>";
    html += "<p>–•–∞–± –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã</p>";
    html += "<script>setTimeout(() => location.href='/', 3000)</script>";
    html += "</body></html>";
    
    webServer.send(200, "text/html", html);
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º
    if (hubMode) {
      hubMode = false;
    } else {
      hubMode = true;
    }
    
    delay(1000);
    ESP.restart();
  });
  
  webServer.on("/restart", HTTP_GET, []() {
    webServer.send(200, "text/plain", "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...");
    delay(1000);
    ESP.restart();
  });
  
  webServer.on("/status", HTTP_GET, []() {
    String json = "{";
    json += "\"mode\":\"" + String(hubMode ? "hub" : "client") + "\",";
    json += "\"devices\":\"" + String(connectedDevices) + "\",";
    json += "\"ip\":\"" + (hubMode ? WiFi.softAPIP().toString() : WiFi.localIP().toString()) + "\",";
    json += "\"rssi\":\"" + String(WiFi.RSSI()) + "\"";
    json += "}";
    
    webServer.send(200, "application/json", json);
  });
  
  webServer.begin();
  Serial.println("–í–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 80");
}

void factoryReset() {
  Serial.println("–°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º...");
  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å EEPROM –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  delay(2000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ —Å —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
void checkServerCommands() {
  String serverURL = "http://" + String(SERVER_IP) + ":" + String(SERVER_PORT) + "/command/" + String(HUB_ID) + "/check";
  
  http.begin(client, serverURL);
  int httpCode = http.GET();
  
  if (httpCode == HTTP_CODE_OK) {
    String command = http.getString();
    command.trim();
    
    if (command == "scan") {
      // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–π
      int n = WiFi.scanNetworks();
      Serial.println("–ù–∞–π–¥–µ–Ω–æ —Å–µ—Ç–µ–π: " + String(n));
      sendStatus("scan:" + String(n));
    } else if (command == "restart") {
      ESP.restart();
    } else if (command == "mode") {
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞
      if (hubMode) {
        hubMode = false;
      } else {
        hubMode = true;
      }
      sendStatus("mode:" + String(hubMode ? "hub" : "client"));
    }
  }
  
  http.end();
}
